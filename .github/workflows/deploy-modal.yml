name: Deploy Modal

on:
  workflow_call:
    inputs:
      ref:
        description: "Git ref to checkout"
        required: true
        type: string
      environment:
        description: "Target environment"
        type: string
        default: "production"
      health-check-url:
        description: "URL to curl after deploy (expects JSON with status:ok)"
        type: string
        default: ""

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/mnemom-prover
          ref: ${{ inputs.ref }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - run: pip install modal

      - name: Deploy to Modal
        run: modal deploy modal_app.py
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}

      - name: Health check
        if: inputs.health-check-url != ''
        run: |
          # Modal serverless may cold-start the container on first request.
          # SP1 prover init can take 60-120s, so allow up to 3 min.
          for i in $(seq 1 18); do
            HTTP_STATUS=$(curl -sf -o /dev/null -w '%{http_code}' --max-time 15 "${{ inputs.health-check-url }}" 2>/dev/null || true)
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "Health check passed (${{ inputs.health-check-url }})"
              exit 0
            fi
            echo "Attempt $i/18: HTTP $HTTP_STATUS â€” retrying in 10s..."
            sleep 10
          done
          echo "::error::Health check failed after 18 attempts (${{ inputs.health-check-url }})"
          exit 1
