name: Deploy Cloudflare Worker

on:
  workflow_call:
    inputs:
      repository:
        description: "Repository to deploy (e.g. mnemom/mnemom-api)"
        required: true
        type: string
      ref:
        description: "Git ref to checkout"
        required: true
        type: string
      environment:
        description: "Target environment (staging or production)"
        required: true
        type: string
      working-directory:
        description: "Directory containing wrangler.toml"
        type: string
        default: "."
      node-version:
        description: "Node.js version"
        type: string
        default: "20"
      pre-install-command:
        description: "Command to run before npm ci (e.g. build shared deps)"
        type: string
        default: ""
      cache-dependency-path:
        description: "Path to package-lock.json for npm cache"
        type: string
        default: "package-lock.json"
      health-check-url:
        description: "URL to curl after deploy (expects JSON with status:ok)"
        type: string
        default: ""

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm
          cache-dependency-path: ${{ inputs.cache-dependency-path }}

      - name: Pre-install
        if: inputs.pre-install-command != ''
        run: ${{ inputs.pre-install-command }}

      - run: npm ci
        working-directory: ${{ inputs.working-directory }}

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ${{ inputs.working-directory }}
          command: deploy --env ${{ inputs.environment }}

      - name: Health check
        if: inputs.health-check-url != ''
        run: |
          for i in 1 2 3; do
            HTTP_STATUS=$(curl -sf -o /dev/null -w '%{http_code}' "${{ inputs.health-check-url }}" 2>/dev/null || true)
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "Health check passed (${{ inputs.health-check-url }})"
              exit 0
            fi
            echo "Attempt $i: HTTP $HTTP_STATUS â€” retrying in 5s..."
            sleep 5
          done
          echo "::error::Health check failed after 3 attempts (${{ inputs.health-check-url }})"
          exit 1
