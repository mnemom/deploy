name: Publish npm (+ optional PyPI)

on:
  workflow_call:
    inputs:
      repository:
        description: "Repository to publish from"
        required: true
        type: string
      ref:
        description: "Git ref to checkout"
        required: true
        type: string
      npm-directory:
        description: "Directory containing package.json for npm"
        required: true
        type: string
      access:
        description: "npm publish access level"
        type: string
        default: "public"
      publish-pypi:
        description: "Also publish to PyPI"
        type: boolean
        default: false
      pypi-directory:
        description: "Directory containing Python package (setup.py/pyproject.toml)"
        type: string
        default: "."
      pypi-method:
        description: "PyPI publish method: twine or gh-action"
        type: string
        default: "twine"

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"
        env:
          NODE_AUTH_TOKEN: "setup"

      - uses: actions/setup-python@v5
        if: inputs.publish-pypi
        with:
          python-version: "3.12"

      - name: Check if version already published
        id: version-check
        working-directory: ${{ inputs.npm-directory }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_READ_TOKEN }}
        run: |
          LOCAL=$(node -p "require('./package.json').version")
          PKG_NAME=$(node -p "require('./package.json').name")
          REMOTE=$(npm view "$PKG_NAME" version 2>/dev/null || echo "0.0.0")
          echo "local=$LOCAL" >> "$GITHUB_OUTPUT"
          echo "remote=$REMOTE" >> "$GITHUB_OUTPUT"
          if [ "$LOCAL" = "$REMOTE" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "$PKG_NAME v$LOCAL already published — skipping"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "Publishing $PKG_NAME v$LOCAL (npm has v$REMOTE)"
          fi

      - name: Build
        if: steps.version-check.outputs.skip != 'true'
        working-directory: ${{ inputs.npm-directory }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_READ_TOKEN }}
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
          npm run build

      - name: Prepare OIDC publish
        if: steps.version-check.outputs.skip != 'true'
        run: |
          echo "npm: $(npm --version)  node: $(node --version)"

          # Decode OIDC token claims so we can verify trusted publisher config
          OIDC_TOKEN=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=npm:registry.npmjs.org" | jq -r '.value')
          echo "::group::OIDC token claims (for trusted publisher matching)"
          echo "$OIDC_TOKEN" | cut -d. -f2 | base64 -d 2>/dev/null | jq '{
            iss, sub, aud, repository, repository_owner,
            workflow_ref, job_workflow_ref, environment, ref, event_name
          }'
          echo "::endgroup::"

          # Remove the _authToken line that setup-node created.
          # It interferes with OIDC — npm sees it and skips OIDC token override.
          npm config delete "//registry.npmjs.org/:_authToken" 2>/dev/null || true
          npm config delete "always-auth" 2>/dev/null || true

      - name: Publish npm
        if: steps.version-check.outputs.skip != 'true'
        working-directory: ${{ inputs.npm-directory }}
        run: npm publish --provenance --access ${{ inputs.access }} --loglevel verbose

      - name: Build Python
        if: inputs.publish-pypi
        working-directory: ${{ inputs.pypi-directory }}
        run: pip install build twine && python -m build

      - name: Publish PyPI (twine)
        if: inputs.publish-pypi && inputs.pypi-method == 'twine'
        working-directory: ${{ inputs.pypi-directory }}
        run: twine upload dist/* --skip-existing
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}

      - name: Publish PyPI (trusted publisher)
        if: inputs.publish-pypi && inputs.pypi-method == 'gh-action'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: ${{ inputs.pypi-directory }}/dist/
          skip-existing: true
