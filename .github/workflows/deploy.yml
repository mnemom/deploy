name: Deploy

on:
  repository_dispatch:
    types: [deploy]
  workflow_dispatch:
    inputs:
      repos:
        description: "Repos to deploy (comma-separated, or 'all')"
        required: true
        default: "all"
        type: string
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - staging
          - production

concurrency:
  group: deploy
  cancel-in-progress: false

jobs:
  # ─────────────────────────────────────────────
  # Plan: determine what to deploy and where
  # ─────────────────────────────────────────────
  plan:
    name: Plan
    runs-on: ubuntu-latest
    outputs:
      deploy-smoltbot: ${{ steps.plan.outputs.deploy-smoltbot }}
      deploy-mnemom-api: ${{ steps.plan.outputs.deploy-mnemom-api }}
      deploy-mnemom-reputation: ${{ steps.plan.outputs.deploy-mnemom-reputation }}
      deploy-mnemom-risk: ${{ steps.plan.outputs.deploy-mnemom-risk }}
      deploy-mnemom-prover: ${{ steps.plan.outputs.deploy-mnemom-prover }}
      deploy-mnemom-website: ${{ steps.plan.outputs.deploy-mnemom-website }}
      deploy-hunter: ${{ steps.plan.outputs.deploy-hunter }}
      deploy-aap: ${{ steps.plan.outputs.deploy-aap }}
      deploy-aip: ${{ steps.plan.outputs.deploy-aip }}
      deploy-aip-otel-exporter: ${{ steps.plan.outputs.deploy-aip-otel-exporter }}
      deploy-mnemom-types: ${{ steps.plan.outputs.deploy-mnemom-types }}
      promote: ${{ steps.plan.outputs.promote }}
      source-ref: ${{ steps.plan.outputs.source-ref }}
      source-repo: ${{ steps.plan.outputs.source-repo }}
    steps:
      - name: Determine deployment plan
        id: plan
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            REPO="${{ github.event.client_payload.repo }}"
            ENV="${{ github.event.client_payload.environment }}"
            REF="${{ github.event.client_payload.sha }}"
          else
            REPO="${{ inputs.repos }}"
            ENV="${{ inputs.environment }}"
            REF=""
          fi

          if [ -z "$ENV" ]; then
            echo "::error::Environment not specified"
            exit 1
          fi

          # Determine whether to promote to production
          if [ "$ENV" = "production" ]; then
            echo "promote=true" >> "$GITHUB_OUTPUT"
          else
            echo "promote=false" >> "$GITHUB_OUTPUT"
          fi

          echo "source-ref=$REF" >> "$GITHUB_OUTPUT"
          echo "source-repo=$REPO" >> "$GITHUB_OUTPUT"

          # Normalize repo name (strip org prefix)
          normalize() { echo "$1" | sed 's|mnemom/||'; }

          set_deploy() {
            echo "deploy-$1=true" >> "$GITHUB_OUTPUT"
            echo "  → $1"
          }

          echo "Deploy plan (promote=$ENV):"

          if [ "$REPO" = "all" ]; then
            set_deploy "smoltbot"
            set_deploy "mnemom-api"
            set_deploy "mnemom-reputation"
            set_deploy "mnemom-risk"
            set_deploy "mnemom-prover"
            set_deploy "mnemom-website"
            set_deploy "hunter"
            set_deploy "aap"
            set_deploy "aip"
            set_deploy "aip-otel-exporter"
            set_deploy "mnemom-types"
          else
            # Handle comma-separated list or single repo from dispatch
            # Note: unknown repo names are accepted here by design — they simply
            # produce an output that no job matches on, so they get silently skipped.
            for r in $(echo "$REPO" | tr ',' ' '); do
              r=$(normalize "$(echo "$r" | xargs)")
              set_deploy "$r"
            done
          fi

  # ═══════════════════════════════════════════════
  # STAGING PHASE (auto, no approval)
  # ═══════════════════════════════════════════════

  # ─────────────────────────────────────────────
  # Staging Tier 1 — Services (parallel)
  # ─────────────────────────────────────────────

  staging-gateway:
    name: "staging / gateway"
    needs: plan
    if: needs.plan.outputs.deploy-smoltbot == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: staging
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/smoltbot
          ref: ${{ needs.plan.outputs.source-repo == 'smoltbot' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: gateway/package-lock.json

      - run: npm ci
        working-directory: gateway

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: gateway
          command: deploy --env staging

  staging-observer:
    name: "staging / observer"
    needs: plan
    if: needs.plan.outputs.deploy-smoltbot == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: staging
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/smoltbot
          ref: ${{ needs.plan.outputs.source-repo == 'smoltbot' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: observer/package-lock.json

      - run: npm ci
        working-directory: observer

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: observer
          command: deploy --env staging

  staging-api:
    name: "staging / api"
    needs: plan
    if: needs.plan.outputs.deploy-mnemom-api == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: staging
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/mnemom-api
          ref: ${{ needs.plan.outputs.source-repo == 'mnemom-api' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - run: npm ci

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env staging

  staging-reputation:
    name: "staging / reputation"
    needs: plan
    if: needs.plan.outputs.deploy-mnemom-reputation == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: staging
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/mnemom-reputation
          ref: ${{ needs.plan.outputs.source-repo == 'mnemom-reputation' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: server/package-lock.json

      - run: npm ci
        working-directory: server

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: server
          command: deploy --env staging

  staging-risk:
    name: "staging / risk"
    needs: plan
    if: needs.plan.outputs.deploy-mnemom-risk == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: staging
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/mnemom-risk
          ref: ${{ needs.plan.outputs.source-repo == 'mnemom-risk' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: server/package-lock.json

      - run: npm ci
        working-directory: server

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: server
          command: deploy --env staging

  staging-prover:
    name: "staging / prover"
    needs: plan
    if: needs.plan.outputs.deploy-mnemom-prover == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: staging
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/mnemom-prover
          ref: ${{ needs.plan.outputs.source-repo == 'mnemom-prover' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - run: pip install modal

      - name: Deploy to Modal
        run: modal deploy modal_app.py
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}

  # ─────────────────────────────────────────────
  # Staging Tier 2 — Consumers (after services)
  # ─────────────────────────────────────────────

  staging-website:
    name: "staging / website"
    needs: [plan, staging-gateway, staging-observer, staging-api, staging-reputation, staging-risk, staging-prover]
    if: >-
      always() &&
      needs.plan.outputs.deploy-mnemom-website == 'true' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: staging
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/mnemom-website
          ref: ${{ needs.plan.outputs.source-repo == 'mnemom-website' && needs.plan.outputs.source-ref || 'staging' }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build:client
        env:
          VITE_API_URL: https://api-staging.mnemom.ai
          VITE_GATEWAY_URL: https://gateway-staging.mnemom.ai
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Deploy
        run: |
          npx netlify-cli deploy \
            --alias staging \
            --no-build \
            --dir=dist/spa \
            --message "Staging deploy from ${{ needs.plan.outputs.source-ref || 'manual' }}"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  staging-hunter:
    name: "staging / hunter"
    needs: [plan, staging-gateway, staging-observer, staging-api, staging-reputation, staging-risk, staging-prover]
    if: >-
      always() &&
      needs.plan.outputs.deploy-hunter == 'true' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: staging
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/hunter
          ref: main
          token: ${{ steps.app-token.outputs.token }}

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        run: flyctl deploy --config fly.staging.toml
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  # ─────────────────────────────────────────────
  # Staging Gate
  # ─────────────────────────────────────────────

  staging-complete:
    name: "Staging Complete"
    needs: [staging-gateway, staging-observer, staging-api, staging-reputation, staging-risk, staging-prover, staging-website, staging-hunter]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## Staging Deploy Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Service | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| gateway | ${{ needs.staging-gateway.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| observer | ${{ needs.staging-observer.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| api | ${{ needs.staging-api.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| reputation | ${{ needs.staging-reputation.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| risk | ${{ needs.staging-risk.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| prover | ${{ needs.staging-prover.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| website | ${{ needs.staging-website.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| hunter | ${{ needs.staging-hunter.result }} |" >> "$GITHUB_STEP_SUMMARY"
      - name: Check for failures
        if: contains(needs.*.result, 'failure')
        run: |
          echo "Staging deployment failed — production will not proceed"
          exit 1

  # ═══════════════════════════════════════════════
  # PRODUCTION PHASE (requires approval)
  # ═══════════════════════════════════════════════

  # ─────────────────────────────────────────────
  # Production Tier 0 — Packages (npm/PyPI only)
  # ─────────────────────────────────────────────

  prod-types:
    name: "prod / mnemom-types (publish)"
    needs: [plan, staging-complete]
    if: >-
      always() &&
      needs.plan.outputs.deploy-mnemom-types == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom
      - uses: actions/checkout@v4
        with:
          repository: mnemom/mnemom-types
          ref: ${{ needs.plan.outputs.source-repo == 'mnemom-types' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Check if version already published
        id: version-check
        run: |
          LOCAL=$(node -p "require('./package.json').version")
          REMOTE=$(npm view @mnemom/types version 2>/dev/null || echo "0.0.0")
          echo "local=$LOCAL" >> "$GITHUB_OUTPUT"
          echo "remote=$REMOTE" >> "$GITHUB_OUTPUT"
          if [ "$LOCAL" = "$REMOTE" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "v$LOCAL already published — skipping"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "Publishing v$LOCAL (npm has v$REMOTE)"
          fi
      - name: Build
        if: steps.version-check.outputs.skip != 'true'
        run: npm ci && npm run build
      - name: Publish npm
        if: steps.version-check.outputs.skip != 'true'
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - name: Publish PyPI
        run: |
          cd python && pip install build twine && python -m build
          twine upload dist/* --skip-existing
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}

  prod-aap:
    name: "prod / aap (publish)"
    needs: [plan, staging-complete]
    if: >-
      always() &&
      needs.plan.outputs.deploy-aap == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom
      - uses: actions/checkout@v4
        with:
          repository: mnemom/aap
          ref: ${{ needs.plan.outputs.source-repo == 'aap' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Check if version already published
        id: version-check
        working-directory: typescript
        run: |
          LOCAL=$(node -p "require('./package.json').version")
          REMOTE=$(npm view @mnemom/aap version 2>/dev/null || echo "0.0.0")
          echo "local=$LOCAL" >> "$GITHUB_OUTPUT"
          echo "remote=$REMOTE" >> "$GITHUB_OUTPUT"
          if [ "$LOCAL" = "$REMOTE" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "v$LOCAL already published — skipping"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "Publishing v$LOCAL (npm has v$REMOTE)"
          fi
      - name: Build
        if: steps.version-check.outputs.skip != 'true'
        working-directory: typescript
        run: npm ci && npm run build
      - name: Publish npm
        if: steps.version-check.outputs.skip != 'true'
        working-directory: typescript
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - name: Publish PyPI
        run: |
          pip install build twine && python -m build
          twine upload dist/* --skip-existing
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}

  prod-aip:
    name: "prod / aip (publish)"
    needs: [plan, staging-complete]
    if: >-
      always() &&
      needs.plan.outputs.deploy-aip == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom
      - uses: actions/checkout@v4
        with:
          repository: mnemom/aip
          ref: ${{ needs.plan.outputs.source-repo == 'aip' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Check if version already published
        id: version-check
        working-directory: packages/typescript
        run: |
          LOCAL=$(node -p "require('./package.json').version")
          REMOTE=$(npm view @mnemom/aip version 2>/dev/null || echo "0.0.0")
          echo "local=$LOCAL" >> "$GITHUB_OUTPUT"
          echo "remote=$REMOTE" >> "$GITHUB_OUTPUT"
          if [ "$LOCAL" = "$REMOTE" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "v$LOCAL already published — skipping"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "Publishing v$LOCAL (npm has v$REMOTE)"
          fi
      - name: Build
        if: steps.version-check.outputs.skip != 'true'
        working-directory: packages/typescript
        run: npm ci && npm run build
      - name: Publish npm
        if: steps.version-check.outputs.skip != 'true'
        working-directory: packages/typescript
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - name: Build Python
        run: cd packages/python && pip install build && python -m build
      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: packages/python/dist/
          skip-existing: true

  prod-otel:
    name: "prod / aip-otel-exporter (publish)"
    needs: [plan, staging-complete]
    if: >-
      always() &&
      needs.plan.outputs.deploy-aip-otel-exporter == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom
      - uses: actions/checkout@v4
        with:
          repository: mnemom/aip-otel-exporter
          ref: ${{ needs.plan.outputs.source-repo == 'aip-otel-exporter' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Check if version already published
        id: version-check
        working-directory: packages/typescript
        run: |
          LOCAL=$(node -p "require('./package.json').version")
          REMOTE=$(npm view @mnemom/aip-otel-exporter version 2>/dev/null || echo "0.0.0")
          echo "local=$LOCAL" >> "$GITHUB_OUTPUT"
          echo "remote=$REMOTE" >> "$GITHUB_OUTPUT"
          if [ "$LOCAL" = "$REMOTE" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "v$LOCAL already published — skipping"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "Publishing v$LOCAL (npm has v$REMOTE)"
          fi
      - name: Build
        if: steps.version-check.outputs.skip != 'true'
        working-directory: packages/typescript
        run: npm ci && npm run build
      - name: Publish npm
        if: steps.version-check.outputs.skip != 'true'
        working-directory: packages/typescript
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - name: Build Python
        run: cd packages/python && pip install build && python -m build
      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: packages/python/dist/
          skip-existing: true

  # ─────────────────────────────────────────────
  # Production Tier 1 — Services (after packages)
  # ─────────────────────────────────────────────

  prod-gateway:
    name: "prod / gateway"
    needs: [plan, staging-complete, prod-types, prod-aap, prod-aip, prod-otel]
    if: >-
      always() &&
      needs.plan.outputs.deploy-smoltbot == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/smoltbot
          ref: ${{ needs.plan.outputs.source-repo == 'smoltbot' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: gateway/package-lock.json

      - run: npm ci
        working-directory: gateway

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: gateway
          command: deploy --env production

  prod-observer:
    name: "prod / observer"
    needs: [plan, staging-complete, prod-types, prod-aap, prod-aip, prod-otel]
    if: >-
      always() &&
      needs.plan.outputs.deploy-smoltbot == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/smoltbot
          ref: ${{ needs.plan.outputs.source-repo == 'smoltbot' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: observer/package-lock.json

      - run: npm ci
        working-directory: observer

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: observer
          command: deploy --env production

  prod-api:
    name: "prod / api"
    needs: [plan, staging-complete, prod-types, prod-aap, prod-aip, prod-otel]
    if: >-
      always() &&
      needs.plan.outputs.deploy-mnemom-api == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/mnemom-api
          ref: ${{ needs.plan.outputs.source-repo == 'mnemom-api' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - run: npm ci

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env production

  prod-reputation:
    name: "prod / reputation"
    needs: [plan, staging-complete, prod-types, prod-aap, prod-aip, prod-otel]
    if: >-
      always() &&
      needs.plan.outputs.deploy-mnemom-reputation == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/mnemom-reputation
          ref: ${{ needs.plan.outputs.source-repo == 'mnemom-reputation' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: server/package-lock.json

      - run: npm ci
        working-directory: server

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: server
          command: deploy --env production

  prod-risk:
    name: "prod / risk"
    needs: [plan, staging-complete, prod-types, prod-aap, prod-aip, prod-otel]
    if: >-
      always() &&
      needs.plan.outputs.deploy-mnemom-risk == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/mnemom-risk
          ref: ${{ needs.plan.outputs.source-repo == 'mnemom-risk' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: server/package-lock.json

      - run: npm ci
        working-directory: server

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: server
          command: deploy --env production

  prod-prover:
    name: "prod / prover"
    needs: [plan, staging-complete, prod-types, prod-aap, prod-aip, prod-otel]
    if: >-
      always() &&
      needs.plan.outputs.deploy-mnemom-prover == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/mnemom-prover
          ref: ${{ needs.plan.outputs.source-repo == 'mnemom-prover' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - run: pip install modal

      - name: Deploy to Modal
        run: modal deploy modal_app.py
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}

  # ─────────────────────────────────────────────
  # Production Tier 2 — Consumers (after services)
  # ─────────────────────────────────────────────

  prod-website:
    name: "prod / website"
    needs: [plan, staging-complete, prod-gateway, prod-observer, prod-api, prod-reputation, prod-risk, prod-prover]
    if: >-
      always() &&
      needs.plan.outputs.deploy-mnemom-website == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/mnemom-website
          ref: ${{ needs.plan.outputs.source-repo == 'mnemom-website' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build:client
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Deploy
        run: |
          npx netlify-cli deploy \
            --prod \
            --no-build \
            --dir=dist/spa \
            --message "Production deploy from ${{ needs.plan.outputs.source-ref || 'manual' }}"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  prod-cli:
    name: "prod / cli (publish)"
    needs: [plan, staging-complete, prod-gateway, prod-observer, prod-api, prod-reputation, prod-risk, prod-prover]
    if: >-
      always() &&
      needs.plan.outputs.deploy-smoltbot == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/smoltbot
          ref: ${{ needs.plan.outputs.source-repo == 'smoltbot' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: cli/package-lock.json
          registry-url: "https://registry.npmjs.org"

      - run: npm ci
        working-directory: cli

      - name: Check if version already published
        id: version-check
        working-directory: cli
        run: |
          LOCAL=$(node -p "require('./package.json').version")
          REMOTE=$(npm view @mnemom/smoltbot version 2>/dev/null || echo "0.0.0")
          echo "local=$LOCAL" >> "$GITHUB_OUTPUT"
          echo "remote=$REMOTE" >> "$GITHUB_OUTPUT"
          if [ "$LOCAL" = "$REMOTE" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "CLI v$LOCAL already published — skipping"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "Publishing CLI v$LOCAL (npm has v$REMOTE)"
          fi

      - name: Build
        if: steps.version-check.outputs.skip != 'true'
        working-directory: cli
        run: npm run build

      - name: Publish
        if: steps.version-check.outputs.skip != 'true'
        working-directory: cli
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  prod-hunter:
    name: "prod / hunter"
    needs: [plan, staging-complete, prod-gateway, prod-observer, prod-api, prod-reputation, prod-risk, prod-prover]
    if: >-
      always() &&
      needs.plan.outputs.deploy-hunter == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/hunter
          ref: main
          token: ${{ steps.app-token.outputs.token }}

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        run: flyctl deploy --config fly.toml
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  # ─────────────────────────────────────────────
  # Summary
  # ─────────────────────────────────────────────

  summary:
    name: Deploy Complete
    if: always()
    needs: [plan, staging-complete, prod-types, prod-aap, prod-aip, prod-otel, prod-gateway, prod-observer, prod-api, prod-reputation, prod-risk, prod-prover, prod-website, prod-cli, prod-hunter]
    runs-on: ubuntu-latest
    steps:
      - name: Results
        run: |
          echo "## Deploy Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Staging" >> "$GITHUB_STEP_SUMMARY"
          echo "| Service | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Staging Gate | ${{ needs.staging-complete.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ needs.plan.outputs.promote }}" = "true" ]; then
            echo "### Production" >> "$GITHUB_STEP_SUMMARY"
            echo "| Service | Status |" >> "$GITHUB_STEP_SUMMARY"
            echo "|---------|--------|" >> "$GITHUB_STEP_SUMMARY"
            echo "| mnemom-types | ${{ needs.prod-types.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| aap | ${{ needs.prod-aap.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| aip | ${{ needs.prod-aip.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| aip-otel-exporter | ${{ needs.prod-otel.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| gateway | ${{ needs.prod-gateway.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| observer | ${{ needs.prod-observer.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| api | ${{ needs.prod-api.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| reputation | ${{ needs.prod-reputation.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| risk | ${{ needs.prod-risk.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| prover | ${{ needs.prod-prover.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| website | ${{ needs.prod-website.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| cli | ${{ needs.prod-cli.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| hunter | ${{ needs.prod-hunter.result }} |" >> "$GITHUB_STEP_SUMMARY"
          fi
      - name: Check for failures
        if: contains(needs.*.result, 'failure')
        run: |
          echo "One or more deploy jobs failed"
          exit 1
