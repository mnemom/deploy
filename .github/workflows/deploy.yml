name: Deploy

on:
  repository_dispatch:
    types: [deploy]
  workflow_dispatch:
    inputs:
      repos:
        description: "Repos to deploy (comma-separated, or 'all')"
        required: true
        default: "all"
        type: string
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - staging
          - production

concurrency:
  group: deploy-${{ github.event.client_payload.repo || inputs.repos || 'manual' }}-${{ github.event.client_payload.environment || inputs.environment || 'staging' }}
  cancel-in-progress: false

jobs:
  # ─────────────────────────────────────────────
  # Plan: determine what to deploy and where
  # ─────────────────────────────────────────────
  plan:
    name: Plan
    runs-on: ubuntu-latest
    outputs:
      deploy-smoltbot: ${{ steps.plan.outputs.deploy-smoltbot }}
      deploy-mnemom-api: ${{ steps.plan.outputs.deploy-mnemom-api }}
      deploy-mnemom-reputation: ${{ steps.plan.outputs.deploy-mnemom-reputation }}
      deploy-mnemom-risk: ${{ steps.plan.outputs.deploy-mnemom-risk }}
      deploy-mnemom-prover: ${{ steps.plan.outputs.deploy-mnemom-prover }}
      deploy-mnemom-website: ${{ steps.plan.outputs.deploy-mnemom-website }}
      deploy-hunter: ${{ steps.plan.outputs.deploy-hunter }}
      deploy-aap: ${{ steps.plan.outputs.deploy-aap }}
      deploy-aip: ${{ steps.plan.outputs.deploy-aip }}
      deploy-aip-otel-exporter: ${{ steps.plan.outputs.deploy-aip-otel-exporter }}
      deploy-mnemom-types: ${{ steps.plan.outputs.deploy-mnemom-types }}
      deploy-mnemom-reputation-sdk: ${{ steps.plan.outputs.deploy-mnemom-reputation-sdk }}
      deploy-mnemom-risk-sdk: ${{ steps.plan.outputs.deploy-mnemom-risk-sdk }}
      deploy-fault-lines: ${{ steps.plan.outputs.deploy-fault-lines }}
      promote: ${{ steps.plan.outputs.promote }}
      source-ref: ${{ steps.plan.outputs.source-ref }}
      source-repo: ${{ steps.plan.outputs.source-repo }}
    steps:
      - name: Determine deployment plan
        id: plan
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            REPO="${{ github.event.client_payload.repo }}"
            ENV="${{ github.event.client_payload.environment }}"
            REF="${{ github.event.client_payload.sha }}"
          else
            REPO="${{ inputs.repos }}"
            ENV="${{ inputs.environment }}"
            REF=""
          fi

          if [ -z "$ENV" ]; then
            echo "::error::Environment not specified"
            exit 1
          fi

          # Determine whether to promote to production
          if [ "$ENV" = "production" ]; then
            echo "promote=true" >> "$GITHUB_OUTPUT"
          else
            echo "promote=false" >> "$GITHUB_OUTPUT"
          fi

          echo "source-ref=$REF" >> "$GITHUB_OUTPUT"
          echo "source-repo=$REPO" >> "$GITHUB_OUTPUT"

          # Normalize repo name (strip org prefix)
          normalize() { echo "$1" | sed 's|mnemom/||'; }

          set_deploy() {
            echo "deploy-$1=true" >> "$GITHUB_OUTPUT"
            echo "  → $1"
          }

          echo "Deploy plan (promote=$ENV):"

          if [ "$REPO" = "all" ]; then
            set_deploy "smoltbot"
            set_deploy "mnemom-api"
            set_deploy "mnemom-reputation"
            set_deploy "mnemom-risk"
            set_deploy "mnemom-prover"
            set_deploy "mnemom-website"
            set_deploy "hunter"
            set_deploy "aap"
            set_deploy "aip"
            set_deploy "aip-otel-exporter"
            set_deploy "mnemom-types"
            set_deploy "mnemom-reputation-sdk"
            set_deploy "mnemom-risk-sdk"
            set_deploy "fault-lines"
          else
            # Handle comma-separated list or single repo from dispatch
            # Note: unknown repo names are accepted here by design — they simply
            # produce an output that no job matches on, so they get silently skipped.
            for r in $(echo "$REPO" | tr ',' ' '); do
              r=$(normalize "$(echo "$r" | xargs)")
              set_deploy "$r"
              # Also deploy client SDK when the parent repo is deployed
              case "$r" in
                mnemom-reputation) set_deploy "mnemom-reputation-sdk" ;;
                mnemom-risk) set_deploy "mnemom-risk-sdk" ;;
              esac
            done
          fi

  # ═══════════════════════════════════════════════
  # STAGING PHASE (auto, no approval)
  # ═══════════════════════════════════════════════

  # ─────────────────────────────────────────────
  # Staging Tier 1 — Services (parallel)
  # ─────────────────────────────────────────────

  staging-gateway:
    name: "staging / gateway"
    needs: plan
    if: needs.plan.outputs.deploy-smoltbot == 'true'
    uses: ./.github/workflows/deploy-cloudflare-worker.yml
    with:
      repository: mnemom/smoltbot
      ref: ${{ needs.plan.outputs.source-repo == 'smoltbot' && needs.plan.outputs.source-ref || 'main' }}
      environment: staging
      working-directory: gateway
      pre-install-command: "cd shared/policy-engine && npm ci && npm run build"
      cache-dependency-path: gateway/package-lock.json
      health-check-url: https://gateway-staging.mnemom.ai/health
    secrets: inherit

  staging-observer:
    name: "staging / observer"
    needs: plan
    if: needs.plan.outputs.deploy-smoltbot == 'true'
    uses: ./.github/workflows/deploy-cloudflare-worker.yml
    with:
      repository: mnemom/smoltbot
      ref: ${{ needs.plan.outputs.source-repo == 'smoltbot' && needs.plan.outputs.source-ref || 'main' }}
      environment: staging
      working-directory: observer
      pre-install-command: "cd shared/policy-engine && npm ci && npm run build"
      cache-dependency-path: observer/package-lock.json
    secrets: inherit

  staging-api:
    name: "staging / api"
    needs: plan
    if: needs.plan.outputs.deploy-mnemom-api == 'true'
    uses: ./.github/workflows/deploy-cloudflare-worker.yml
    with:
      repository: mnemom/mnemom-api
      ref: ${{ needs.plan.outputs.source-repo == 'mnemom-api' && needs.plan.outputs.source-ref || 'main' }}
      environment: staging
      health-check-url: https://api-staging.mnemom.ai/health
    secrets: inherit

  staging-reputation:
    name: "staging / reputation"
    needs: plan
    if: needs.plan.outputs.deploy-mnemom-reputation == 'true'
    uses: ./.github/workflows/deploy-cloudflare-worker.yml
    with:
      repository: mnemom/mnemom-reputation
      ref: ${{ needs.plan.outputs.source-repo == 'mnemom-reputation' && needs.plan.outputs.source-ref || 'main' }}
      environment: staging
      working-directory: server
      cache-dependency-path: server/package-lock.json
    secrets: inherit

  staging-risk:
    name: "staging / risk"
    needs: plan
    if: needs.plan.outputs.deploy-mnemom-risk == 'true'
    uses: ./.github/workflows/deploy-cloudflare-worker.yml
    with:
      repository: mnemom/mnemom-risk
      ref: ${{ needs.plan.outputs.source-repo == 'mnemom-risk' && needs.plan.outputs.source-ref || 'main' }}
      environment: staging
      working-directory: server
      cache-dependency-path: server/package-lock.json
    secrets: inherit

  staging-prover:
    name: "staging / prover"
    needs: plan
    if: needs.plan.outputs.deploy-mnemom-prover == 'true'
    uses: ./.github/workflows/deploy-modal.yml
    with:
      ref: ${{ needs.plan.outputs.source-repo == 'mnemom-prover' && needs.plan.outputs.source-ref || 'main' }}
      environment: staging
    secrets: inherit

  # ─────────────────────────────────────────────
  # Staging Tier 2 — Consumers (after services)
  # ─────────────────────────────────────────────

  staging-website:
    name: "staging / website"
    needs: [plan, staging-gateway, staging-observer, staging-api, staging-reputation, staging-risk, staging-prover]
    if: >-
      always() &&
      needs.plan.outputs.deploy-mnemom-website == 'true' &&
      !contains(needs.*.result, 'failure')
    uses: ./.github/workflows/deploy-netlify.yml
    with:
      ref: ${{ needs.plan.outputs.source-repo == 'mnemom-website' && needs.plan.outputs.source-ref || 'main' }}
      environment: staging
    secrets: inherit

  # ─────────────────────────────────────────────
  # Staging Gate
  # ─────────────────────────────────────────────

  staging-complete:
    name: "Staging Complete"
    needs: [staging-gateway, staging-observer, staging-api, staging-reputation, staging-risk, staging-prover, staging-website]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## Staging Deploy Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Service | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| gateway | ${{ needs.staging-gateway.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| observer | ${{ needs.staging-observer.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| api | ${{ needs.staging-api.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| reputation | ${{ needs.staging-reputation.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| risk | ${{ needs.staging-risk.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| prover | ${{ needs.staging-prover.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| website | ${{ needs.staging-website.result }} |" >> "$GITHUB_STEP_SUMMARY"
      - name: Check for failures
        if: contains(needs.*.result, 'failure')
        run: |
          echo "Staging deployment failed — production will not proceed"
          exit 1

  # ═══════════════════════════════════════════════
  # PRODUCTION PHASE (requires approval)
  # ═══════════════════════════════════════════════

  # ─────────────────────────────────────────────
  # Production Tier 0 — Packages (npm/PyPI only)
  # ─────────────────────────────────────────────

  prod-types:
    name: "prod / mnemom-types (publish)"
    needs: [plan, staging-complete]
    if: >-
      always() &&
      needs.plan.outputs.deploy-mnemom-types == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    uses: ./.github/workflows/dispatch-publish.yml
    with:
      repository: mnemom/mnemom-types
    secrets: inherit

  prod-aap:
    name: "prod / aap (publish)"
    needs: [plan, staging-complete]
    if: >-
      always() &&
      needs.plan.outputs.deploy-aap == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    uses: ./.github/workflows/dispatch-publish.yml
    with:
      repository: mnemom/aap
    secrets: inherit

  prod-aip:
    name: "prod / aip (publish)"
    needs: [plan, staging-complete]
    if: >-
      always() &&
      needs.plan.outputs.deploy-aip == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    uses: ./.github/workflows/dispatch-publish.yml
    with:
      repository: mnemom/aip
    secrets: inherit

  prod-otel:
    name: "prod / aip-otel-exporter (publish)"
    needs: [plan, staging-complete]
    if: >-
      always() &&
      needs.plan.outputs.deploy-aip-otel-exporter == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    uses: ./.github/workflows/dispatch-publish.yml
    with:
      repository: mnemom/aip-otel-exporter
    secrets: inherit

  prod-policy-engine:
    name: "prod / policy-engine (publish)"
    needs: [plan, staging-complete]
    if: >-
      always() &&
      needs.plan.outputs.deploy-smoltbot == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    uses: ./.github/workflows/dispatch-publish.yml
    with:
      repository: mnemom/smoltbot
      npm-directory: shared/policy-engine
    secrets: inherit

  prod-fault-lines:
    name: "prod / fault-lines (publish)"
    needs: [plan, staging-complete]
    if: >-
      always() &&
      needs.plan.outputs.deploy-fault-lines == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    uses: ./.github/workflows/dispatch-publish.yml
    with:
      repository: mnemom/fault-lines
      access: restricted
    secrets: inherit

  prod-reputation-sdk:
    name: "prod / reputation-sdk (publish)"
    needs: [plan, staging-complete]
    if: >-
      always() &&
      needs.plan.outputs.deploy-mnemom-reputation-sdk == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    uses: ./.github/workflows/dispatch-publish.yml
    with:
      repository: mnemom/mnemom-reputation
    secrets: inherit

  prod-risk-sdk:
    name: "prod / risk-sdk (publish)"
    needs: [plan, staging-complete]
    if: >-
      always() &&
      needs.plan.outputs.deploy-mnemom-risk-sdk == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    uses: ./.github/workflows/dispatch-publish.yml
    with:
      repository: mnemom/mnemom-risk
    secrets: inherit

  # ─────────────────────────────────────────────
  # Production Tier 1 — Services (after packages)
  # ─────────────────────────────────────────────

  prod-gateway:
    name: "prod / gateway"
    # deps: @mnemom/agent-integrity-protocol, @mnemom/aip-otel-exporter (npm)
    # policy-engine is file: link, built from source via pre-install-command
    needs: [plan, staging-complete, prod-aip, prod-otel]
    if: >-
      always() &&
      needs.plan.outputs.deploy-smoltbot == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    uses: ./.github/workflows/deploy-cloudflare-worker.yml
    with:
      repository: mnemom/smoltbot
      ref: ${{ needs.plan.outputs.source-repo == 'smoltbot' && needs.plan.outputs.source-ref || 'main' }}
      environment: production
      working-directory: gateway
      pre-install-command: "cd shared/policy-engine && npm ci && npm run build"
      cache-dependency-path: gateway/package-lock.json
      health-check-url: https://gateway.mnemom.ai/health
    secrets: inherit

  prod-observer:
    name: "prod / observer"
    # deps: @mnemom/agent-alignment-protocol, @mnemom/aip-otel-exporter (npm)
    # policy-engine is file: link, built from source via pre-install-command
    needs: [plan, staging-complete, prod-aap, prod-otel]
    if: >-
      always() &&
      needs.plan.outputs.deploy-smoltbot == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    uses: ./.github/workflows/deploy-cloudflare-worker.yml
    with:
      repository: mnemom/smoltbot
      ref: ${{ needs.plan.outputs.source-repo == 'smoltbot' && needs.plan.outputs.source-ref || 'main' }}
      environment: production
      working-directory: observer
      pre-install-command: "cd shared/policy-engine && npm ci && npm run build"
      cache-dependency-path: observer/package-lock.json
    secrets: inherit

  prod-api:
    name: "prod / api"
    # deps: @mnemom/policy-engine, @mnemom/fault-lines, @mnemom/aap, @mnemom/aip (all npm)
    needs: [plan, staging-complete, prod-policy-engine, prod-fault-lines, prod-aap, prod-aip]
    if: >-
      always() &&
      needs.plan.outputs.deploy-mnemom-api == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    uses: ./.github/workflows/deploy-cloudflare-worker.yml
    with:
      repository: mnemom/mnemom-api
      ref: ${{ needs.plan.outputs.source-repo == 'mnemom-api' && needs.plan.outputs.source-ref || 'main' }}
      environment: production
      health-check-url: https://api.mnemom.ai/health
    secrets: inherit

  prod-reputation:
    name: "prod / reputation"
    # SDK published first so version matches the API the Worker serves
    needs: [plan, staging-complete, prod-reputation-sdk]
    if: >-
      always() &&
      needs.plan.outputs.deploy-mnemom-reputation == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    uses: ./.github/workflows/deploy-cloudflare-worker.yml
    with:
      repository: mnemom/mnemom-reputation
      ref: ${{ needs.plan.outputs.source-repo == 'mnemom-reputation' && needs.plan.outputs.source-ref || 'main' }}
      environment: production
      working-directory: server
      cache-dependency-path: server/package-lock.json
    secrets: inherit

  prod-risk:
    name: "prod / risk"
    # deps: @mnemom/types (npm), SDK published first
    needs: [plan, staging-complete, prod-types, prod-risk-sdk]
    if: >-
      always() &&
      needs.plan.outputs.deploy-mnemom-risk == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    uses: ./.github/workflows/deploy-cloudflare-worker.yml
    with:
      repository: mnemom/mnemom-risk
      ref: ${{ needs.plan.outputs.source-repo == 'mnemom-risk' && needs.plan.outputs.source-ref || 'main' }}
      environment: production
      working-directory: server
      cache-dependency-path: server/package-lock.json
    secrets: inherit

  prod-prover:
    name: "prod / prover"
    # pure Rust — no npm package deps
    needs: [plan, staging-complete]
    if: >-
      always() &&
      needs.plan.outputs.deploy-mnemom-prover == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    uses: ./.github/workflows/deploy-modal.yml
    with:
      ref: ${{ needs.plan.outputs.source-repo == 'mnemom-prover' && needs.plan.outputs.source-ref || 'main' }}
      environment: production
    secrets: inherit

  # ─────────────────────────────────────────────
  # Production Tier 2 — Consumers (after services)
  # ─────────────────────────────────────────────

  prod-website:
    name: "prod / website"
    # runtime HTTP deps: api.mnemom.ai, gateway.mnemom.ai
    # @mnemom/aap (npm) satisfied transitively via prod-api
    needs: [plan, staging-complete, prod-gateway, prod-api]
    if: >-
      always() &&
      needs.plan.outputs.deploy-mnemom-website == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    uses: ./.github/workflows/deploy-netlify.yml
    with:
      ref: ${{ needs.plan.outputs.source-repo == 'mnemom-website' && needs.plan.outputs.source-ref || 'main' }}
      environment: production
      health-check-url: https://mnemom.ai
    secrets: inherit

  prod-cli:
    name: "prod / cli (publish)"
    # runtime HTTP deps: api.mnemom.ai, gateway.mnemom.ai
    # policy-engine is file: link, built from source
    needs: [plan, staging-complete, prod-gateway, prod-api]
    if: >-
      always() &&
      needs.plan.outputs.deploy-smoltbot == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    uses: ./.github/workflows/dispatch-publish.yml
    with:
      repository: mnemom/smoltbot
      npm-directory: cli
    secrets: inherit

  prod-hunter:
    name: "prod / hunter"
    # runtime HTTP deps: gateway.mnemom.ai, api.mnemom.ai
    needs: [plan, staging-complete, prod-gateway, prod-api]
    if: >-
      always() &&
      needs.plan.outputs.deploy-hunter == 'true' &&
      needs.plan.outputs.promote == 'true' &&
      !contains(needs.*.result, 'failure')
    uses: ./.github/workflows/deploy-fly.yml
    with:
      repository: mnemom/hunter
      ref: main
      environment: production
    secrets: inherit

  # ─────────────────────────────────────────────
  # Summary
  # ─────────────────────────────────────────────

  summary:
    name: Deploy Complete
    if: always()
    needs: [plan, staging-complete, prod-types, prod-aap, prod-aip, prod-otel, prod-policy-engine, prod-fault-lines, prod-reputation-sdk, prod-risk-sdk, prod-gateway, prod-observer, prod-api, prod-reputation, prod-risk, prod-prover, prod-website, prod-cli, prod-hunter]
    runs-on: ubuntu-latest
    steps:
      - name: Results
        run: |
          echo "## Deploy Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Staging" >> "$GITHUB_STEP_SUMMARY"
          echo "| Service | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Staging Gate | ${{ needs.staging-complete.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ needs.plan.outputs.promote }}" = "true" ]; then
            echo "### Production" >> "$GITHUB_STEP_SUMMARY"
            echo "| Service | Status |" >> "$GITHUB_STEP_SUMMARY"
            echo "|---------|--------|" >> "$GITHUB_STEP_SUMMARY"
            echo "| mnemom-types | ${{ needs.prod-types.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| aap | ${{ needs.prod-aap.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| aip | ${{ needs.prod-aip.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| aip-otel-exporter | ${{ needs.prod-otel.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| policy-engine | ${{ needs.prod-policy-engine.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| fault-lines | ${{ needs.prod-fault-lines.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| reputation-sdk | ${{ needs.prod-reputation-sdk.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| risk-sdk | ${{ needs.prod-risk-sdk.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| gateway | ${{ needs.prod-gateway.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| observer | ${{ needs.prod-observer.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| api | ${{ needs.prod-api.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| reputation | ${{ needs.prod-reputation.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| risk | ${{ needs.prod-risk.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| prover | ${{ needs.prod-prover.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| website | ${{ needs.prod-website.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| cli | ${{ needs.prod-cli.result }} |" >> "$GITHUB_STEP_SUMMARY"
            echo "| hunter | ${{ needs.prod-hunter.result }} |" >> "$GITHUB_STEP_SUMMARY"
          fi
      - name: Check for failures
        if: contains(needs.*.result, 'failure')
        run: |
          echo "One or more deploy jobs failed"
          exit 1
