name: Deploy

on:
  repository_dispatch:
    types: [deploy]
  workflow_dispatch:
    inputs:
      repos:
        description: "Repos to deploy (comma-separated, or 'all')"
        required: true
        default: "all"
        type: string
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - staging
          - production

concurrency:
  group: deploy-${{ github.event.client_payload.environment || inputs.environment }}
  cancel-in-progress: false

jobs:
  # ─────────────────────────────────────────────
  # Plan: determine what to deploy and where
  # ─────────────────────────────────────────────
  plan:
    name: Plan
    runs-on: ubuntu-latest
    outputs:
      env: ${{ steps.plan.outputs.env }}
      deploy-smoltbot: ${{ steps.plan.outputs.deploy-smoltbot }}
      deploy-mnemom-api: ${{ steps.plan.outputs.deploy-mnemom-api }}
      deploy-mnemom-reputation: ${{ steps.plan.outputs.deploy-mnemom-reputation }}
      deploy-mnemom-risk: ${{ steps.plan.outputs.deploy-mnemom-risk }}
      deploy-mnemom-prover: ${{ steps.plan.outputs.deploy-mnemom-prover }}
      deploy-mnemom-website: ${{ steps.plan.outputs.deploy-mnemom-website }}
      deploy-hunter: ${{ steps.plan.outputs.deploy-hunter }}
      deploy-aap: ${{ steps.plan.outputs.deploy-aap }}
      deploy-aip: ${{ steps.plan.outputs.deploy-aip }}
      deploy-aip-otel-exporter: ${{ steps.plan.outputs.deploy-aip-otel-exporter }}
      deploy-mnemom-types: ${{ steps.plan.outputs.deploy-mnemom-types }}
      source-ref: ${{ steps.plan.outputs.source-ref }}
      source-repo: ${{ steps.plan.outputs.source-repo }}
    steps:
      - name: Determine deployment plan
        id: plan
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            REPO="${{ github.event.client_payload.repo }}"
            ENV="${{ github.event.client_payload.environment }}"
            REF="${{ github.event.client_payload.sha }}"
          else
            REPO="${{ inputs.repos }}"
            ENV="${{ inputs.environment }}"
            REF=""
          fi

          if [ -z "$ENV" ]; then
            echo "::error::Environment not specified"
            exit 1
          fi

          echo "env=$ENV" >> "$GITHUB_OUTPUT"
          echo "source-ref=$REF" >> "$GITHUB_OUTPUT"
          echo "source-repo=$REPO" >> "$GITHUB_OUTPUT"

          # Normalize repo name (strip org prefix)
          normalize() { echo "$1" | sed 's|mnemom/||'; }

          set_deploy() {
            echo "deploy-$1=true" >> "$GITHUB_OUTPUT"
            echo "  → $1"
          }

          echo "Deploy plan for $ENV:"

          if [ "$REPO" = "all" ]; then
            set_deploy "smoltbot"
            set_deploy "mnemom-api"
            set_deploy "mnemom-reputation"
            set_deploy "mnemom-risk"
            set_deploy "mnemom-prover"
            set_deploy "mnemom-website"
            set_deploy "hunter"
            set_deploy "aap"
            set_deploy "aip"
            set_deploy "aip-otel-exporter"
            set_deploy "mnemom-types"
          else
            # Handle comma-separated list or single repo from dispatch
            # Note: unknown repo names are accepted here by design — they simply
            # produce an output that no job matches on, so they get silently skipped.
            for r in $(echo "$REPO" | tr ',' ' '); do
              r=$(normalize "$(echo "$r" | xargs)")
              set_deploy "$r"
            done
          fi

  # ─────────────────────────────────────────────
  # All deploy jobs run in parallel after plan
  # ─────────────────────────────────────────────

  smoltbot-gateway:
    name: "smoltbot / gateway"
    needs: plan
    if: needs.plan.outputs.deploy-smoltbot == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ needs.plan.outputs.env }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/smoltbot
          ref: ${{ needs.plan.outputs.source-repo == 'smoltbot' && needs.plan.outputs.source-ref || (needs.plan.outputs.env == 'production' && 'main' || 'staging') }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: gateway/package-lock.json

      - run: npm ci
        working-directory: gateway

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: gateway
          command: deploy --env ${{ needs.plan.outputs.env }}

  smoltbot-observer:
    name: "smoltbot / observer"
    needs: plan
    if: needs.plan.outputs.deploy-smoltbot == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ needs.plan.outputs.env }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/smoltbot
          ref: ${{ needs.plan.outputs.source-repo == 'smoltbot' && needs.plan.outputs.source-ref || (needs.plan.outputs.env == 'production' && 'main' || 'staging') }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: observer/package-lock.json

      - run: npm ci
        working-directory: observer

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: observer
          command: deploy --env ${{ needs.plan.outputs.env }}

  smoltbot-cli:
    name: "smoltbot / cli (publish)"
    needs: plan
    if: needs.plan.outputs.deploy-smoltbot == 'true' && needs.plan.outputs.env == 'production'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ needs.plan.outputs.env }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/smoltbot
          ref: ${{ needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: cli/package-lock.json
          registry-url: "https://registry.npmjs.org"

      - run: npm ci
        working-directory: cli

      - name: Check if version already published
        id: version-check
        working-directory: cli
        run: |
          LOCAL=$(node -p "require('./package.json').version")
          REMOTE=$(npm view @mnemom/smoltbot version 2>/dev/null || echo "0.0.0")
          echo "local=$LOCAL" >> "$GITHUB_OUTPUT"
          echo "remote=$REMOTE" >> "$GITHUB_OUTPUT"
          if [ "$LOCAL" = "$REMOTE" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "CLI v$LOCAL already published — skipping"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "Publishing CLI v$LOCAL (npm has v$REMOTE)"
          fi

      - name: Build
        if: steps.version-check.outputs.skip != 'true'
        working-directory: cli
        run: npm run build

      - name: Publish
        if: steps.version-check.outputs.skip != 'true'
        working-directory: cli
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  mnemom-api:
    name: "mnemom-api"
    needs: plan
    if: needs.plan.outputs.deploy-mnemom-api == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ needs.plan.outputs.env }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/mnemom-api
          ref: ${{ needs.plan.outputs.source-repo == 'mnemom-api' && needs.plan.outputs.source-ref || (needs.plan.outputs.env == 'production' && 'main' || 'staging') }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - run: npm ci

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env ${{ needs.plan.outputs.env }}

  mnemom-reputation:
    name: "mnemom-reputation"
    needs: plan
    if: needs.plan.outputs.deploy-mnemom-reputation == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ needs.plan.outputs.env }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/mnemom-reputation
          ref: ${{ needs.plan.outputs.source-repo == 'mnemom-reputation' && needs.plan.outputs.source-ref || (needs.plan.outputs.env == 'production' && 'main' || 'staging') }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: server/package-lock.json

      - run: npm ci
        working-directory: server

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: server
          command: deploy --env ${{ needs.plan.outputs.env }}

  mnemom-risk:
    name: "mnemom-risk"
    needs: plan
    if: needs.plan.outputs.deploy-mnemom-risk == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ needs.plan.outputs.env }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/mnemom-risk
          ref: ${{ needs.plan.outputs.source-repo == 'mnemom-risk' && needs.plan.outputs.source-ref || (needs.plan.outputs.env == 'production' && 'main' || 'staging') }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: server/package-lock.json

      - run: npm ci
        working-directory: server

      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: server
          command: deploy --env ${{ needs.plan.outputs.env }}

  mnemom-prover:
    name: "mnemom-prover"
    needs: plan
    if: needs.plan.outputs.deploy-mnemom-prover == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ needs.plan.outputs.env }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/mnemom-prover
          ref: ${{ needs.plan.outputs.source-repo == 'mnemom-prover' && needs.plan.outputs.source-ref || (needs.plan.outputs.env == 'production' && 'main' || 'staging') }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - run: pip install modal

      - name: Deploy to Modal
        run: modal deploy modal_app.py
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}

  mnemom-website:
    name: "mnemom-website"
    needs: plan
    if: needs.plan.outputs.deploy-mnemom-website == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ needs.plan.outputs.env }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/mnemom-website
          ref: ${{ needs.plan.outputs.source-repo == 'mnemom-website' && needs.plan.outputs.source-ref || (needs.plan.outputs.env == 'production' && 'main' || 'staging') }}
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - uses: pnpm/action-setup@v4

      - run: pnpm install --frozen-lockfile
        working-directory: client

      - name: Build
        working-directory: client
        run: pnpm build:client
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Deploy
        working-directory: client
        run: |
          npx netlify deploy \
            ${{ needs.plan.outputs.env == 'production' && '--prod' || '--alias staging' }} \
            --no-build \
            --dir=dist \
            --site=${{ secrets.NETLIFY_SITE_ID }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

  hunter:
    name: "hunter"
    needs: plan
    if: needs.plan.outputs.deploy-hunter == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ needs.plan.outputs.env }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom

      - uses: actions/checkout@v4
        with:
          repository: mnemom/hunter
          ref: main
          token: ${{ steps.app-token.outputs.token }}

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        run: |
          if [ "${{ needs.plan.outputs.env }}" = "production" ]; then
            flyctl deploy --config fly.toml
          else
            flyctl deploy --config fly.staging.toml
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  aap:
    name: "aap (publish)"
    needs: plan
    if: needs.plan.outputs.deploy-aap == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ needs.plan.outputs.env }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom
      - uses: actions/checkout@v4
        with:
          repository: mnemom/aap
          ref: ${{ needs.plan.outputs.source-repo == 'aap' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Publish npm
        run: |
          cd typescript && npm ci && npm run build
          REMOTE=$(npm view @mnemom/aap version 2>/dev/null || echo "0.0.0")
          LOCAL=$(node -p "require('./package.json').version")
          if [ "$LOCAL" != "$REMOTE" ]; then npm publish --access public; else echo "v$LOCAL already published"; fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - name: Publish PyPI
        run: |
          pip install build twine && python -m build
          twine upload dist/* --skip-existing
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}

  aip:
    name: "aip (publish)"
    needs: plan
    if: needs.plan.outputs.deploy-aip == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ needs.plan.outputs.env }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom
      - uses: actions/checkout@v4
        with:
          repository: mnemom/aip
          ref: ${{ needs.plan.outputs.source-repo == 'aip' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Publish npm
        run: |
          cd packages/typescript && npm ci && npm run build
          REMOTE=$(npm view @mnemom/aip version 2>/dev/null || echo "0.0.0")
          LOCAL=$(node -p "require('./package.json').version")
          if [ "$LOCAL" != "$REMOTE" ]; then npm publish --access public; else echo "v$LOCAL already published"; fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - name: Build Python
        run: cd packages/python && pip install build && python -m build
      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: packages/python/dist/
          skip-existing: true

  aip-otel-exporter:
    name: "aip-otel-exporter (publish)"
    needs: plan
    if: needs.plan.outputs.deploy-aip-otel-exporter == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ needs.plan.outputs.env }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom
      - uses: actions/checkout@v4
        with:
          repository: mnemom/aip-otel-exporter
          ref: ${{ needs.plan.outputs.source-repo == 'aip-otel-exporter' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Publish npm
        run: |
          cd packages/typescript && npm ci && npm run build
          REMOTE=$(npm view @mnemom/aip-otel-exporter version 2>/dev/null || echo "0.0.0")
          LOCAL=$(node -p "require('./package.json').version")
          if [ "$LOCAL" != "$REMOTE" ]; then npm publish --access public; else echo "v$LOCAL already published"; fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - name: Build Python
        run: cd packages/python && pip install build && python -m build
      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: packages/python/dist/
          skip-existing: true

  mnemom-types:
    name: "mnemom-types (publish)"
    needs: plan
    if: needs.plan.outputs.deploy-mnemom-types == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ needs.plan.outputs.env }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: mnemom
      - uses: actions/checkout@v4
        with:
          repository: mnemom/mnemom-types
          ref: ${{ needs.plan.outputs.source-repo == 'mnemom-types' && needs.plan.outputs.source-ref || 'main' }}
          token: ${{ steps.app-token.outputs.token }}
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Publish npm
        run: |
          npm ci && npm run build
          REMOTE=$(npm view @mnemom/types version 2>/dev/null || echo "0.0.0")
          LOCAL=$(node -p "require('./package.json').version")
          if [ "$LOCAL" != "$REMOTE" ]; then npm publish --access public; else echo "v$LOCAL already published"; fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - name: Publish PyPI
        run: |
          cd python && pip install build twine && python -m build
          twine upload dist/* --skip-existing
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}

  # ─────────────────────────────────────────────
  # Summary
  # ─────────────────────────────────────────────

  summary:
    name: Deploy Complete
    if: always()
    needs:
      - plan
      - smoltbot-gateway
      - smoltbot-observer
      - smoltbot-cli
      - mnemom-api
      - mnemom-reputation
      - mnemom-risk
      - mnemom-prover
      - mnemom-website
      - hunter
      - aap
      - aip
      - aip-otel-exporter
      - mnemom-types
    runs-on: ubuntu-latest
    steps:
      - name: Results
        run: |
          echo "## Deploy Summary (${{ needs.plan.outputs.env }})" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Service | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| smoltbot/gateway | ${{ needs.smoltbot-gateway.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| smoltbot/observer | ${{ needs.smoltbot-observer.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| smoltbot/cli | ${{ needs.smoltbot-cli.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| mnemom-api | ${{ needs.mnemom-api.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| mnemom-reputation | ${{ needs.mnemom-reputation.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| mnemom-risk | ${{ needs.mnemom-risk.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| mnemom-prover | ${{ needs.mnemom-prover.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| mnemom-website | ${{ needs.mnemom-website.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| hunter | ${{ needs.hunter.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| aap | ${{ needs.aap.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| aip | ${{ needs.aip.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| aip-otel-exporter | ${{ needs.aip-otel-exporter.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| mnemom-types | ${{ needs.mnemom-types.result }} |" >> "$GITHUB_STEP_SUMMARY"

      - name: Check for failures
        if: contains(needs.*.result, 'failure')
        run: |
          echo "One or more deploy jobs failed"
          exit 1
